package per.wei.util;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.ibatis.cache.Cache;

import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;
import redis.clients.jedis.JedisPoolConfig;



/** 
* @author  作者 : wangwev
* @date 创建时间：2017年11月25日 上午10:49:19   
*/
public class RedisCache implements Cache{

	private static Log logger = LogFactory.getLog(RedisCache.class);  
    private Jedis redisClient = createClient();  
    /** The ReadWriteLock. */  
    private final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();  
      
    private String id;  
    public RedisCache(final String id) {  
            if (id == null) {  
                    throw new IllegalArgumentException("Cache instances require an ID");  
            }  
            logger.debug(">>>>>>>>>>>>>>>>>>>>>>>>MybatisRedisCache:id=" + id);  
            this.id = id;  
    }  

    @Override  
    public String getId() {  
            return this.id;  
    }  

    @Override  
    public int getSize() {  
            return Integer.valueOf(redisClient.dbSize().toString());  
    }  

    @Override  
    public void putObject(Object key, Object value) {  
            logger.debug(">>>>>>>>>>>>>>>>>>>>>>>>putObject:" + key + "=" + value);  
            redisClient.set(SerializeUtil.serialize(key.toString()), SerializeUtil.serialize(value));  
    }  

    @Override  
    public Object getObject(Object key) {  
            Object value = SerializeUtil.unserialize(redisClient.get(SerializeUtil.serialize(key.toString())));  
            logger.debug(">>>>>>>>>>>>>>>>>>>>>>>>getObject:" + key + "=" + value);  
            return value;  
    }  

    @Override  
    public Object removeObject(Object key) {  
            return redisClient.expire(SerializeUtil.serialize(key.toString()), 0);  
    }  

    @Override  
    public void clear() {  
            redisClient.flushDB();  
    }  

    @Override  
    public ReadWriteLock getReadWriteLock() {  
            return readWriteLock;  
    }  
     
    protected  static Jedis createClient() {  
            try {  
                    JedisPool pool = new JedisPool(new JedisPoolConfig(), "127.0.0.1");  
                   return pool.getResource();  
            } catch (Exception e) {  
                    e.printStackTrace();  
            }  
            throw new RuntimeException("初始化连接池错误");  
    }  
      

      
}  


class SerializeUtil {  
    public static byte[] serialize(Object object) {  
            ObjectOutputStream oos = null;  
            ByteArrayOutputStream baos = null;  
            try {  
                    // 序列化  
                    baos = new ByteArrayOutputStream();  
                    oos = new ObjectOutputStream(baos);  
                    oos.writeObject(object);  
                    byte[] bytes = baos.toByteArray();  
                    return bytes;  
            } catch (Exception e) {  
                    e.printStackTrace();  
            }  
            return null;  
    }  

    public static Object unserialize(byte[] bytes) {  
            if(bytes == null)return null;  
            ByteArrayInputStream bais = null;  
            try {  
                    // 反序列化  
                    bais = new ByteArrayInputStream(bytes);  
                    ObjectInputStream ois = new ObjectInputStream(bais);  
                    return ois.readObject();  
            } catch (Exception e) {  
                    e.printStackTrace();  
            }  
            return null;  
    }  
} 

